---
title:  "[Reapberrypi] 04. TensorFlow Lite Interpreter 설정"
excerpt: "Raspberry Pi에서 TensorFlow-Lite를 실행하기 위한 interpreter를 설정하고, 예제를 실행해봅니다."

categories:
  - Dev
tags:
  - Yocto
  - Raspberry Pi
  - TensorFlow-Lite
---

## 1. TensorFlow Lite Python 개발환경 구축

### (1) Yocto build 시 tensorflow-lite recipe 추가

- 다음 repository를 참고하여 다음과 같이 bitbake recipe를 수정 빌드한다. 
[https://github.com/NobuoTsukamoto/meta-tensorflow-lite](https://github.com/NobuoTsukamoto/meta-tensorflow-lite)

### (2) Classification 예제 Test

/media/Data/Dev/tflite_classification_demo

- TensorFlow Lite에서 제공하는 예제를 수정하여 실행해본다.
[https://github.com/tensorflow/tensorflow/tree/master/tensorflow/lite/examples/python/](https://github.com/tensorflow/tensorflow/tree/master/tensorflow/lite/examples/python/)
- Sample image와 mobileNet V1 pre-trained model 및 label 정보를 다운로드 한다.

    ```bash
    # Get photo
    curl https://raw.githubusercontent.com/tensorflow/tensorflow/master/tensorflow/lite/examples/label_image/testdata/grace_hopper.bmp > grace_hopper.bmp
    # Get model
    curl https://storage.googleapis.com/download.tensorflow.org/models/mobilenet_v1_2018_02_22/mobilenet_v1_1.0_224.tgz | tar xzv -C .
    # Get labels
    curl https://storage.googleapis.com/download.tensorflow.org/models/mobilenet_v1_1.0_224_frozen.tgz  | tar xzv -C . labels.txt
    ```

- 다음 가이드를 참고하여 "label_image.py" 파일을 다음과 수정한다. [https://www.tensorflow.org/lite/guide/python?hl=ko#tflite_runtime을_사용하여_추론_실행하기](https://www.tensorflow.org/lite/guide/python?hl=ko#tflite_runtime%EC%9D%84_%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC_%EC%B6%94%EB%A1%A0_%EC%8B%A4%ED%96%89%ED%95%98%EA%B8%B0)
전체 code: [https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/examples/python/label_image.py](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/examples/python/label_image.py)

    ```python
    """label_image for tflite."""

    from __future__ import absolute_import
    from __future__ import division
    from __future__ import print_function

    import argparse
    import time

    import numpy as np
    from PIL import Image
    #import tensorflow as tf
    import tflite_runtime.interpreter as tflite 

    #...
    # line 63
    #interpreter = tf.lite.Interpreter(
    interpreter = tflite.Interpreter(
          model_path=args.model_file, num_threads=args.num_threads)
      interpreter.allocate_tensors()

    ```

- 작성한 file과 weight 파일을 Raspberry Pi로 전송한다. (SSH 연결 기준)

    ```bash
    # 192.168.137.10 IP로 설정된 Raspberry Pi의 "/home/root/" 경로로 전송
    scp label_image.py grace_hopper.bmp labels.txt mobilenet_v1_1.0_224.tflite root@192.168.137.10:/home/root/
    ```

- [In Raspberry Pi] 다음과 같이 label_image.py를 실행해본다.

    ```python
    python3 label_image.py \
      --model_file mobilenet_v1_1.0_224.tflite \
      --label_file labels.txt \
      --image grace_hopper.bmp
    ```

- 실행 결과는 다음과 같다.

    ![tflite-python](https://jerogar.github.io/img/Yocto4/tflite_python_result.png)

## 2. TensorFlow Lite C++

### (1) Libary build

- 본 문서에서는 Respberry Pi 3/4에 적용하기 위해 TensorFlow Lite "ARM 크로스 컴파일 가이드"의 "ARMv7 NEON 용 빌드 지원" 항목을 참고하여 빌드한다.
[https://www.tensorflow.org/lite/guide/build_cmake_arm](https://www.tensorflow.org/lite/guide/build_cmake_arm)
- 라즈베리파이 Yocto build시 생성한 toolchain으로 빌드 환경을 구성한다.
본 문서에서는 64bit로 build된 yocto linux 환경을 사용한다.

    ```bash
    # source {toolchain Path}/{environment setup file name}
    # e.g. 32bit
    source /opt/poky32/3.1.7/environment-setup-cortexa7t2hf-neon-vfpv4-poky-linux-gnueabi
    # e.g. 64bit
    source /opt/poky32/3.1.7/environment-setup-aarch64-poky-linux
    ```

- TensorFlow repository를 clone한다.

    ```bash
    git clone <https://github.com/tensorflow/tensorflow.git> tensorflow_src

    ```

- TensorFlow에서 제공하는 shell script를 실행하여 build 시 필요한 dependency를 다운로드 한다. (최초 1회 수행)

    ```bash
    cd tensorflow_src && ./tensorflow/lite/tools/make/download_dependencies.sh

    ```

- toolchine에 cross compile 환경변수가 지정되어 있으니 다음과 같이 수정된 option을 이용하여 cmake를 실행한다.

    ```bash
    cd tensorflow_src
    mkdir build 
    cd build

    cmake -DCMAKE_C_COMPILER=${CC} \
      -DCMAKE_CXX_COMPILER=${CXX} \
      -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON \
      -DCMAKE_SYSTEM_NAME=Linux \
      -DCMAKE_SYSTEM_PROCESSOR=armv7 \
      ../tensorflow/lite/
    ```

- cmake 실행이 완료되면 다음과 같이 make를 수행한다.

    ```bash
    cmake --build . -j

    # 다음과 같이 error 발생 시 "aarch64-poky-linux-g++: fatal error: Killed signal terminated program cc1plus compilation terminated."
    cmake --build .
    ```

- make 완료시 "libtensorflow-lite.a" 파일이 생성된 것을 확인할 수 있다.

### (2) Minimal Example 실행

/media/Data/Dev/tflite_test

- TensorFlow Lite의 minimal example을 실행해본다. 
전체 Code : [https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/examples/minimal/minimal.cc](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/examples/minimal/minimal.cc)

    ```cpp
    #include <iostream>
    #include "tensorflow/lite/interpreter.h"
    #include "tensorflow/lite/kernels/register.h"
    #include "tensorflow/lite/model.h"
    #include "tensorflow/lite/optional_debug_tools.h"

    int main()
    {
    	std::unique_ptr<tflite::FlatBufferModel> model;
    ...
    ```

- 빌드하기 위한 cmake를 이용하여 빌드한다.
    - 다음과 같이 CMakeLists.txt를 구성한다.

        ```makefile
        #CMakeLists.txt

        cmake_minimum_required(VERSION 3.16)
        project(minimum C CXX)

        set(TENSORFLOW_SOURCE_DIR "" CACHE PATH
          "Directory that contains the TensorFlow project" )
        if(NOT TENSORFLOW_SOURCE_DIR)
          get_filename_component(TENSORFLOW_SOURCE_DIR
            "{TF source path}" ABSOLUTE) # tensorflow 소스코드 다운로드 경로 기입
        endif()

        add_subdirectory(
          "${TENSORFLOW_SOURCE_DIR}/tensorflow/lite"
          "${CMAKE_CURRENT_BINARY_DIR}/tensorflow-lite" EXCLUDE_FROM_ALL)

        add_executable(minimum ../src/main.cpp) # source 코드 기입
        target_link_libraries(minimum tensorflow-lite)
        ```

    - build를 위한 폴더를 생성하고 빌드하면 minimum이란 실행파일이 생성된다.

        ```bash
        mkdir build
        cd build
        cmake ..
        make
        ```

- build한 tensorflow-lite library와 실행파일을 Raspberry Pi에 복사한다.

    ```bash
    # 192.168.137.10 IP로 설정된 Raspberry Pi의 "/home/root/" 경로로 전송
    scp minimum libtensorflow-lite.a root@192.168.137.10:/home/root
    ```

- [In Raspberry Pi] 다음과 같이 실행하여 결과를 확인한다.

    ```bash
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/root/
    cd /home/root
    ./minimal mobilenet_v1_1.0_224.tflite # python 예제에 사용한 pre-trained weight 파일 
    ```

    ![tflite-minimal](https://jerogar.github.io/img/Yocto4/minimal_result.png)